# Документация для Telegram-бота Eng_Bot

## Описание
Eng_Bot — это Telegram-бот, предназначенный для изучения английских слов. Бот позволяет пользователям учить слова, добавлять новые слова в персональный словарь, удалять слова из персонального словаря и отслеживать статистику своих ответов. Бот использует базу данных PostgreSQL для хранения слов и статистики пользователей.

### Основные функции:
- Учить слова с выбором из 4 вариантов ответа.
- Добавлять новые слова в персональный словарь.
- Удалять слова из персонального словаря.
- Отслеживать статистику правильных и неправильных ответов.
- Предотвращать добавление дублирующихся слов.

### Технологии:
- **Язык программирования:** Python 3.x
- **Библиотеки:**
  - `telebot` (pyTelegramBotAPI) — для взаимодействия с Telegram API.
  - `psycopg2` — для работы с базой данных PostgreSQL.
- **База данных:** PostgreSQL
- **Формат ввода:** Слова добавляются в формате "слово, перевод" (например, "дом, house").

---

## Структура базы данных
База данных `Eng_Bot` состоит из трех таблиц:

### 1. `common_words`
- **Описание:** Хранит общий набор слов, доступный всем пользователям.
- **Поля:**
  - `id` (SERIAL, PK): Уникальный идентификатор записи.
  - `word_rus` (VARCHAR(50), NOT NULL): Слово на русском языке.
  - `word_eng` (VARCHAR(50), NOT NULL): Слово на английском языке.
- **Инициализация:** Таблица заполняется 10 предопределенными словами при первом запуске бота, если она пуста.

### 2. `user_words`
- **Описание:** Хранит персональные слова, добавленные пользователями.
- **Поля:**
  - `id` (SERIAL, PK): Уникальный идентификатор записи.
  - `user_id` (BIGINT, NOT NULL): Идентификатор пользователя (логическая связь с `user_stats.user_id`).
  - `word_rus` (VARCHAR(50), NOT NULL): Слово на русском языке.
  - `word_eng` (VARCHAR(50), NOT NULL): Слово на английском языке.
- **Примечание:** Рекомендуется добавить внешний ключ `user_id` → `user_stats.user_id` для обеспечения целостности данных.

### 3. `user_stats`
- **Описание:** Хранит статистику пользователей.
- **Поля:**
  - `user_id` (BIGINT, PK): Уникальный идентификатор пользователя.
  - `correct_answers` (INTEGER, DEFAULT 0): Количество правильных ответов.
  - `total_attempts` (INTEGER, DEFAULT 0): Общее количество попыток.

---

## Основные функции и их реализация

### 1. Подключение к базе данных
- **Функция:** `get_db_connection()`
- **Описание:** Устанавливает соединение с базой данных PostgreSQL.
- **Параметры:** Использует глобальную переменную `DB_CONFIG` с настройками подключения.
- **Возвращаемое значение:** Объект соединения (`psycopg2.connect`).

### 2. Инициализация базы данных
- **Функция:** `init_db()`
- **Описание:** Создает таблицы `common_words`, `user_words` и `user_stats`, если они не существуют. Заполняет `common_words` 10 предопределенными словами, если таблица пуста.
- **Примечание:** Вызывается при запуске бота.

### 3. Генерация вариантов ответа
- **Функция:** `get_answer_options(correct_answer, all_words)`
- **Описание:** Генерирует 4 варианта ответа для теста, включая правильный ответ.
- **Параметры:**
  - `correct_answer` (str): Правильный ответ (на английском).
  - `all_words` (list): Список всех доступных английских слов.
- **Возвращаемое значение:** Список из 4 случайных вариантов ответа (включая правильный).

### 4. Создание клавиатуры
- **Функция:** `create_keyboard(options, callback_prefix)`
- **Описание:** Создает инлайн-клавиатуру с вариантами ответа и дополнительными кнопками "Добавить слово" и "Удалить слово".
- **Параметры:**
  - `options` (list): Список вариантов ответа.
  - `callback_prefix` (str): Префикс для callback-данных (например, `answer|word_rus|word_eng`).
- **Возвращаемое значение:** Объект `InlineKeyboardMarkup`.

- **Функция:** `create_start_keyboard()`
- **Описание:** Создает клавиатуру с кнопкой `/start` для первого входа пользователя.
- **Возвращаемое значение:** Объект `ReplyKeyboardMarkup`.

### 5. Обработка команды `/start`
- **Функция:** `start(message)`
- **Описание:** Обрабатывает команду `/start`. Проверяет, новый ли пользователь, и отправляет соответствующее приветственное сообщение.
- **Логика:**
  - Если пользователь новый, добавляется в `user_stats` и отправляется приветственное сообщение с кнопкой `/start`.
  - Если пользователь уже существует, отправляется меню с командами `/learn`, `/add`, `/delete`.

### 6. Учить слова
- **Функция:** `learn_words(user_id)`
- **Описание:** Отправляет пользователю случайное слово для перевода с 4 вариантами ответа.
- **Параметры:**
  - `user_id` (int): Идентификатор пользователя.
- **Логика:**
  - Получает слова из `common_words` и `user_words`.
  - Если слов нет, отправляет сообщение о пустом словаре.
  - Генерирует варианты ответа и отправляет вопрос с клавиатурой.

- **Функция:** `start_learn(message)`
- **Описание:** Обрабатывает команду `/learn` и вызывает `learn_words`.

### 7. Обработка ответов и команд
- **Функция:** `handle_answer(call)`
- **Описание:** Обрабатывает callback-запросы для ответов на вопросы и команд `/add`, `/delete`.
- **Логика:**
  - Если callback начинается с `command|`:
    - `add`: Запрашивает новое слово для добавления.
    - `delete`: Показывает список слов для удаления.
  - Если callback начинается с `answer|`:
    - Проверяет правильность ответа.
    - При правильном ответе обновляет статистику, отправляет следующий вопрос.
    - При неправильном ответе повторяет тот же вопрос.

### 8. Добавление слова
- **Функция:** `add_word(message)`
- **Описание:** Обрабатывает команду `/add` и запрашивает новое слово.
- **Логика:** Регистрирует следующий шаг через `process_add_word`.

- **Функция:** `process_add_word(message)`
- **Описание:** Обрабатывает ввод нового слова.
- **Логика:**
  - Проверяет, существует ли слово в `user_words` или `common_words`.
  - Если слово существует, запрашивает другое слово.
  - Если слово уникально, добавляет его в `user_words`.

### 9. Удаление слова
- **Функция:** `delete_word(message)`
- **Описание:** Обрабатывает команду `/delete` и показывает список слов для удаления.
- **Логика:** Если слов нет, отправляет сообщение. Иначе создает клавиатуру со списком слов.

- **Функция:** `handle_delete(call)`
- **Описание:** Обрабатывает callback-запросы для удаления слов.
- **Логика:** Удаляет выбранное слово из `user_words` и отправляет подтверждение.

---

## Запуск бота
- **Точка входа:** `if __name__ == "__main__":`
- **Логика:**
  - Вызывает `init_db()` для инициализации базы данных.
  - Запускает бота через `bot.polling(none_stop=True)`.

---

## Рекомендации по улучшению
1. **Добавить внешний ключ:**
   - Добавить `FOREIGN KEY` в `user_words.user_id` → `user_stats.user_id` для обеспечения целостности данных.
2. **Индексы:**
   - Добавить индексы для полей `user_id`, `word_rus`, `word_eng` для оптимизации запросов.
3. **Логирование:**
   - Добавить логирование для отладки и анализа.
4. **Обработка ошибок:**
   - Улучшить обработку исключений для повышения надежности.

---

## Пример использования
1. Пользователь отправляет `/start` → получает приветственное сообщение.
2. Пользователь отправляет `/learn` → получает вопрос с 4 вариантами ответа.
3. Пользователь выбирает ответ:
   - Правильный → получает следующий вопрос.
   - Неправильный → повторяет тот же вопрос.
4. Пользователь отправляет `/add` → добавляет новое слово.
5. Пользователь отправляет `/delete` → удаляет слово из персонального словаря.